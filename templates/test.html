<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reelify - AI Story Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      /* Perfect Color Palette - Dark Theme */
      --dark-bg-primary:#0B0D17;--dark-bg-secondary:#151825;--dark-bg-tertiary:#1E2235;
      --dark-surface:#252944;--dark-surface-hover:#2D3148;
      --dark-text-primary:#FFFFFF;--dark-text-secondary:#B8BCC8;--dark-text-muted:#7A7F8A;
      --dark-border:rgba(255,255,255,0.08);--dark-border-light:rgba(255,255,255,0.04);

      /* Light Theme */
      --light-bg-primary:#FAFBFC;--light-bg-secondary:#F1F3F4;--light-bg-tertiary:#E8EAED;
      --light-surface:#FFFFFF;--light-surface-hover:#F8F9FA;
      --light-text-primary:#1A1A1A;--light-text-secondary:#5F6368;--light-text-muted:#9AA0A6;
      --light-border:rgba(0,0,0,0.12);--light-border-light:rgba(0,0,0,0.06);

      /* Brand */
      --primary:#6366F1;--primary-light:#818CF8;--primary-dark:#4F46E5;
      --secondary:#14B8A6;--secondary-light:#5EEAD4;--accent:#F59E0B;--accent-light:#FCD34D;
      --success:#10B981;--warning:#F59E0B;--error:#EF4444;--info:#3B82F6;

      /* Gradients */
      --gradient-primary:linear-gradient(135deg,#6366F1 0%,#8B5CF6 100%);
      --gradient-secondary:linear-gradient(135deg,#14B8A6 0%,#06B6D4 100%);
      --gradient-warm:linear-gradient(135deg,#F59E0B 0%,#EF4444 100%);
      --gradient-brand:linear-gradient(135deg,#6366F1 0%,#14B8A6 50%,#F59E0B 100%);

      /* Spacing */
      --space-1:.25rem;--space-2:.5rem;--space-3:.75rem;--space-4:1rem;--space-5:1.25rem;--space-6:1.5rem;
      --space-8:2rem;--space-10:2.5rem;--space-12:3rem;--space-16:4rem;--space-20:5rem;

      /* Type */
      --font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      --font-family-display:'Space Grotesk','Inter',sans-serif;
      --font-size-xs:.75rem;--font-size-sm:.875rem;--font-size-base:1rem;--font-size-lg:1.125rem;--font-size-xl:1.25rem;
      --font-size-2xl:1.5rem;--font-size-3xl:1.875rem;--font-size-4xl:2.25rem;--font-size-5xl:3rem;--font-size-6xl:3.75rem;

      /* Shadows */
      --shadow-xs:0 1px 2px 0 rgba(0,0,0,.05);
      --shadow-sm:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);
      --shadow-2xl:0 25px 50px -12px rgba(0,0,0,.25);

      /* Radius */
      --radius-xs:.125rem;--radius-sm:.375rem;--radius-md:.5rem;--radius-lg:.75rem;--radius-xl:1rem;--radius-2xl:1.5rem;--radius-3xl:2rem;--radius-full:9999px;

      /* Transitions */
      --duration-75:75ms;--duration-100:100ms;--duration-150:150ms;--duration-200:200ms;--duration-300:300ms;--duration-500:500ms;--duration-700:700ms;
      --ease-in:cubic-bezier(0.4,0,1,1);--ease-out:cubic-bezier(0,0,0.2,1);--ease-in-out:cubic-bezier(0.4,0,0.2,1);
    }
    .story-meta-container{
  margin-top:var(--space-6);
}

.story-meta{
  border-radius:var(--radius-lg);
  padding:var(--space-4) var(--space-5);
  border:1px solid var(--border);
  background:rgba(30,34,53,0.6);
  font-size:var(--font-size-sm);
  color:var(--text-secondary);
  backdrop-filter:blur(10px);
}

.story-meta-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:var(--space-3);
  margin-bottom:var(--space-2);
  flex-wrap:wrap;
}

.story-meta-badge{
  display:inline-flex;
  align-items:center;
  gap:var(--space-2);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.08em;
  font-size:var(--font-size-xs);
  padding:var(--space-1) var(--space-3);
  border-radius:var(--radius-full);
}

.story-meta-badge i{
  font-size:var(--font-size-xs);
}

/* Verified (green shield) */
.story-meta-verified .story-meta-badge{
  background:rgba(16,185,129,0.15);
  color:#6EE7B7;
}

/* Unverified (yellow triangle) */
.story-meta-unverified .story-meta-badge{
  background:rgba(245,158,11,0.15);
  color:#FCD34D;
}

.story-meta-score{
  font-family:'JetBrains Mono',ui-monospace,monospace;
  font-size:var(--font-size-xs);
  color:var(--text-secondary);
}

.story-meta-note{
  font-size:var(--font-size-xs);
  color:var(--text-muted);
}

/* Sources list */
.story-sources{
  margin-top:var(--space-3);
}

.story-sources-title{
  font-size:var(--font-size-xs);
  text-transform:uppercase;
  letter-spacing:.08em;
  color:var(--text-muted);
  margin-bottom:var(--space-2);
  display:flex;
  align-items:center;
  gap:var(--space-2);
}

.story-sources-title i{
  font-size:var(--font-size-xs);
}

.story-sources-list{
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:var(--space-3);
  margin:0;
  padding:0;
}

.story-source-item{
  display:flex;
  gap:var(--space-3);
  align-items:flex-start;
}

.story-source-index{
  width:22px;
  height:22px;
  border-radius:var(--radius-full);
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:var(--font-size-xs);
  color:var(--text-secondary);
  flex-shrink:0;
}

.story-source-main{
  flex:1;
}

.story-source-title{
  font-size:var(--font-size-sm);
  font-weight:500;
  color:var(--text-primary);
  text-decoration:none;
}

.story-source-title:hover{
  text-decoration:underline;
  color:var(--primary-light);
}

.story-source-meta{
  font-size:var(--font-size-xs);
  color:var(--text-muted);
}

/* Light theme tweak */
[data-theme="light"] .story-meta{
  background:rgba(255,255,255,0.9);
  border:1px solid var(--border);
}

    [data-theme="dark"]{
      --bg-primary:var(--dark-bg-primary);--bg-secondary:var(--dark-bg-secondary);--bg-tertiary:var(--dark-bg-tertiary);
      --surface:var(--dark-surface);--surface-hover:var(--dark-surface-hover);
      --text-primary:var(--dark-text-primary);--text-secondary:var(--dark-text-secondary);--text-muted:var(--dark-text-muted);
      --border:var(--dark-border);--border-light:var(--dark-border-light);
    }
    [data-theme="light"]{
      --bg-primary:var(--light-bg-primary);--bg-secondary:var(--light-bg-secondary);--bg-tertiary:var(--light-bg-tertiary);
      --surface:var(--light-surface);--surface-hover:var(--light-surface-hover);
      --text-primary:var(--light-text-primary);--text-secondary:var(--light-text-secondary);--text-muted:var(--light-text-muted);
      --border:var(--light-border);--border-light:var(--light-border-light);
    }
    
    /* Light Mode Specific Improvements */
    [data-theme="light"] .app-header{
      background:rgba(255,255,255,0.9);
      border-bottom:1px solid var(--border);
      box-shadow:0 2px 20px rgba(0,0,0,0.08);
    }
    
    [data-theme="light"] .panel{
      background:rgba(255,255,255,0.8);
      border:1px solid var(--border);
      box-shadow:0 4px 20px rgba(0,0,0,0.08);
    }
    
    [data-theme="light"] .panel:hover{
      box-shadow:0 8px 30px rgba(0,0,0,0.12);
    }
    
    [data-theme="light"] .panel-header{
      background:rgba(248,249,250,0.8);
      border-bottom:1px solid var(--border);
    }
    
    [data-theme="light"] .controls-grid{
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border);
      box-shadow:0 2px 15px rgba(0,0,0,0.06);
    }
    
    [data-theme="light"] .controls-grid:hover{
      box-shadow:0 4px 20px rgba(0,0,0,0.1);
    }
    
    [data-theme="light"] .status-item{
      background:rgba(255,255,255,0.8);
      border:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .status-item:hover{
      background:rgba(255,255,255,0.95);
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    
    [data-theme="light"] .theme-toggle{
      background:rgba(255,255,255,0.8);
      border:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .theme-toggle:hover{
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    
    [data-theme="light"] .story-content,
    [data-theme="light"] .translation-content,
    [data-theme="light"] .trends-content{
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border);
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .story-content:hover,
    [data-theme="light"] .translation-content:hover,
    [data-theme="light"] .trends-content:hover{
      background:rgba(255,255,255,0.95);
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.06);
    }
    
    [data-theme="light"] .trend-item{
      background:rgba(255,255,255,0.8);
      border:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .trend-item:hover{
      background:rgba(255,255,255,0.95);
      border-color:var(--primary);
      box-shadow:0 4px 15px rgba(99,102,241,0.15);
    }
    
    [data-theme="light"] .trend-item.selected{
      background:rgba(99,102,241,0.08);
      border-color:var(--primary);
      box-shadow:0 4px 15px rgba(99,102,241,0.2);
    }
    
    [data-theme="light"] .field input[type="text"],
    [data-theme="light"] .field input[type="number"],
    [data-theme="light"] .field textarea,
    [data-theme="light"] .field select,
    [data-theme="light"] .field input[type="file"]{
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border);
      box-shadow:inset 0 1px 3px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .field input[type="text"]:focus,
    [data-theme="light"] .field input[type="number"]:focus,
    [data-theme="light"] .field textarea:focus,
    [data-theme="light"] .field select:focus,
    [data-theme="light"] .field input[type="file"]:focus{
      background:rgba(255,255,255,1);
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(99,102,241,0.1), inset 0 1px 3px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .field input[type="text"]:hover,
    [data-theme="light"] .field input[type="number"]:hover,
    [data-theme="light"] .field textarea:hover,
    [data-theme="light"] .field select:hover,
    [data-theme="light"] .field input[type="file"]:hover{
      background:rgba(255,255,255,1);
      border-color:var(--primary);
    }
    
    [data-theme="light"] .location-select{
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border);
      box-shadow:inset 0 1px 3px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .location-select:hover,
    [data-theme="light"] .location-select:focus{
      background:rgba(255,255,255,1);
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(99,102,241,0.1), inset 0 1px 3px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .batch-images-container{
      background:rgba(248,249,250,0.8);
      border:2px dashed var(--border);
    }
    
    [data-theme="light"] .batch-images-container:hover{
      background:rgba(248,249,250,0.9);
      border-color:var(--primary);
    }
    
    [data-theme="light"] .translation-toggle{
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .translation-tab:hover:not(.active){
      background:rgba(248,249,250,0.8);
    }
    
    [data-theme="light"] .notification{
      background:rgba(255,255,255,0.95);
      border:1px solid var(--border);
      box-shadow:0 8px 30px rgba(0,0,0,0.12);
    }
    
    [data-theme="light"] .thumb,
    [data-theme="light"] .video{
      background:rgba(248,249,250,0.8);
      border:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .thumb:hover,
    [data-theme="light"] .video:hover{
      box-shadow:0 4px 15px rgba(0,0,0,0.08);
    }
    
    [data-theme="light"] .batch-images-grid img{
      border:2px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    [data-theme="light"] .batch-images-grid img:hover{
      border-color:var(--primary);
      box-shadow:0 4px 15px rgba(99,102,241,0.15);
    }
    
    [data-theme="light"] .section-title{
      border-bottom:2px solid var(--border);
    }
    
    [data-theme="light"] .section-title::after{
      background:var(--gradient-primary);
    }
    
    /* Enhanced Light Mode Button Styling */
    [data-theme="light"] .btn-primary{
      background:var(--gradient-primary);
      color:#fff;
      box-shadow:0 4px 15px rgba(99,102,241,0.25);
      border:1px solid rgba(99,102,241,0.2);
    }
    
    [data-theme="light"] .btn-primary:hover:not(:disabled){
      box-shadow:0 6px 20px rgba(99,102,241,0.35);
      transform:translateY(-2px);
    }
    
    [data-theme="light"] .btn-secondary{
      background:var(--gradient-secondary);
      color:#fff;
      box-shadow:0 4px 15px rgba(20,184,166,0.25);
      border:1px solid rgba(20,184,166,0.2);
    }
    
    [data-theme="light"] .btn-secondary:hover:not(:disabled){
      box-shadow:0 6px 20px rgba(20,184,166,0.35);
      transform:translateY(-2px);
    }
    
    [data-theme="light"] .btn-accent{
      background:var(--gradient-warm);
      color:#fff;
      box-shadow:0 4px 15px rgba(245,158,11,0.25);
      border:1px solid rgba(245,158,11,0.2);
    }
    
    [data-theme="light"] .btn-accent:hover:not(:disabled){
      box-shadow:0 6px 20px rgba(245,158,11,0.35);
      transform:translateY(-2px);
    }
    
    /* Enhanced Light Mode Panel Footer */
    [data-theme="light"] .panel-footer{
      background:rgba(248,249,250,0.8);
      border-top:1px solid var(--border);
    }
    
    /* Enhanced Light Mode Details/Summary */
    [data-theme="light"] details{
      background:rgba(255,255,255,0.8);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:var(--space-4);
      margin-bottom:var(--space-4);
    }
    
    [data-theme="light"] details summary{
      color:var(--text-primary);
      font-weight:600;
    }
    
    [data-theme="light"] details summary:hover{
      color:var(--primary);
    }
    
    /* Enhanced Light Mode Switch/Toggle Elements */
    [data-theme="light"] .switch input[type="checkbox"]{
      accent-color:var(--primary);
    }
    
    [data-theme="light"] .switch label{
      color:var(--text-primary);
    }
    
    /* Enhanced Light Mode File Upload Button */
    [data-theme="light"] .field input[type="file"]::-webkit-file-upload-button{
      background:var(--gradient-primary);
      color:#fff;
      border:1px solid rgba(99,102,241,0.2);
      box-shadow:0 2px 8px rgba(99,102,241,0.2);
    }
    
    [data-theme="light"] .field input[type="file"]::-webkit-file-upload-button:hover{
      box-shadow:0 4px 12px rgba(99,102,241,0.3);
      transform:translateY(-1px);
    }
    
    /* Enhanced Light Mode Empty States */
    [data-theme="light"] .empty-state .empty-icon{
      color:var(--text-muted);
      opacity:0.6;
    }
    
    [data-theme="light"] .empty-state .empty-title{
      color:var(--text-secondary);
    }
    
    [data-theme="light"] .empty-state .empty-description{
      color:var(--text-muted);
    }
    
    /* Enhanced Light Mode Loading States */
    [data-theme="light"] .spinner{
      border:3px solid var(--border);
      border-top:3px solid var(--primary);
    }
    
    /* Enhanced Light Mode Trend Rank */
    [data-theme="light"] .trend-rank{
      background:var(--gradient-primary);
      color:#fff;
      box-shadow:0 3px 10px rgba(99,102,241,0.25);
    }
    
    [data-theme="light"] .trend-rank:hover{
      box-shadow:0 4px 12px rgba(99,102,241,0.35);
    }
    
    /* Enhanced Light Mode Trend Count */
    [data-theme="light"] .trend-count{
      background:var(--gradient-secondary);
      color:#fff;
      box-shadow:0 2px 6px rgba(20,184,166,0.2);
    }
    
    /* Enhanced Light Mode Panel Icons */
    [data-theme="light"] .panel-icon{
      background:var(--gradient-primary);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    /* Enhanced Light Mode Section Icons */
    [data-theme="light"] .section-title i{
      background:var(--gradient-primary);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    /* Enhanced Light Mode Logo */
    [data-theme="light"] .logo{
      background:var(--gradient-brand);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    /* Enhanced Light Mode Tagline */
    [data-theme="light"] .tagline{
      color:var(--text-muted);
    }
    
    /* Enhanced Light Mode Control Labels */
    [data-theme="light"] .control-label{
      color:var(--text-secondary);
    }
    
    /* Enhanced Light Mode Small Text */
    [data-theme="light"] .small{
      color:var(--text-muted);
    }
    
    /* Enhanced Light Mode Field Labels */
    [data-theme="light"] .field label{
      color:var(--text-secondary);
    }
    
    /* Enhanced Light Mode Panel Subtitles */
    [data-theme="light"] .panel-subtitle{
      color:var(--text-muted);
    }
    
    /* Enhanced Light Mode Trend Names */
    [data-theme="light"] .trend-name{
      color:var(--text-primary);
    }
    
    /* Enhanced Light Mode Trend Descriptions */
    [data-theme="light"] .trend-description{
      color:var(--text-secondary);
    }
    
    /* Enhanced Light Mode Empty Batch State */
    [data-theme="light"] .empty-batch-state .empty-icon{
      color:var(--text-muted);
      opacity:0.6;
    }
    
    [data-theme="light"] .empty-batch-state .empty-title{
      color:var(--text-secondary);
    }
    
    [data-theme="light"] .empty-batch-state .empty-description{
      color:var(--text-muted);
    }
    
    /* Enhanced Light Mode Status Dots */
    [data-theme="light"] .status-dot.online::before{
      background:var(--success);
    }
    
    [data-theme="light"] .status-dot.offline::before{
      background:var(--error);
    }
    
    [data-theme="light"] .status-dot.loading::before{
      background:var(--warning);
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{font-size:16px;scroll-behavior:smooth;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);line-height:1.6;transition:background-color var(--duration-300) var(--ease-in-out),color var(--duration-300) var(--ease-in-out);min-height:100vh;overflow-x:hidden;position:relative}
    body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background-image:radial-gradient(circle at 1px 1px,var(--border-light) 1px,transparent 0);background-size:20px 20px;opacity:0.3;pointer-events:none;z-index:-1}

    .app-container{min-height:100vh;display:flex;flex-direction:column;position:relative}
    .app-header{background:rgba(21,24,37,0.8);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100;box-shadow:0 8px 32px rgba(0,0,0,0.1)}
    .header-content{max-width:1600px;margin:0 auto;padding:var(--space-8);display:flex;align-items:center;justify-content:space-between;gap:var(--space-10)}
    .brand{display:flex;align-items:center;gap:var(--space-4)}
    .logo{font-family:var(--font-family-display);font-size:var(--font-size-3xl);font-weight:800;background:var(--gradient-brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.025em;position:relative;transition:all var(--duration-300) var(--ease-out)}
    .logo::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--gradient-brand);border-radius:var(--radius-full);opacity:0;transform:scaleX(0);transition:all var(--duration-300) var(--ease-out)}
    .logo:hover::after{opacity:1;transform:scaleX(1)}
    .tagline{font-size:var(--font-size-sm);color:var(--text-muted);font-weight:500;margin-left:var(--space-2);padding-left:var(--space-2);border-left:2px solid var(--border)}

    .header-controls{display:flex;align-items:center;gap:var(--space-8)}
    .status-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--space-5)}
    .status-item{display:flex;align-items:center;gap:var(--space-2);padding:var(--space-2) var(--space-3);background:rgba(37,41,68,0.6);border:1px solid var(--border);border-radius:var(--radius-lg);font-size:var(--font-size-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:all var(--duration-200) var(--ease-out);backdrop-filter:blur(10px)}
    .status-item:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.15);background:rgba(37,41,68,0.8)}
    .status-dot{width:10px;height:10px;border-radius:50%;position:relative;box-shadow:0 0 10px rgba(0,0,0,0.3)}
    .status-dot::before{content:'';position:absolute;inset:-2px;border-radius:50%;animation:pulse 2s cubic-bezier(0.4,0,0.6,1) infinite;opacity:0.6}
    .status-dot.online::before{background:var(--success)}
    .status-dot.offline::before{background:var(--error)}
    .status-dot.loading::before{background:var(--warning)}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.1)}}
    .theme-toggle{position:relative;width:56px;height:28px;background:rgba(37,41,68,0.6);border:1px solid var(--border);border-radius:var(--radius-full);cursor:pointer;transition:all var(--duration-200) var(--ease-out);backdrop-filter:blur(10px)}
    .theme-toggle:hover{box-shadow:0 8px 25px rgba(0,0,0,0.15);transform:scale(1.05)}
    .theme-toggle::before{content:'';position:absolute;top:2px;left:2px;width:22px;height:22px;background:var(--gradient-primary);border-radius:50%;transition:transform var(--duration-300) var(--ease-out);box-shadow:0 4px 12px rgba(99,102,241,0.4)}
    .theme-toggle.active::before{transform:translateX(26px)}
    .theme-icon{position:absolute;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-secondary);transition:opacity var(--duration-200) var(--ease-out)}
    .theme-icon.sun{left:7px}.theme-icon.moon{right:7px}
    .theme-toggle:not(.active) .moon{opacity:.4}.theme-toggle.active .sun{opacity:.4}

    .app-main{flex:1;max-width:1600px;margin:0 auto;padding:var(--space-12) var(--space-8);width:100%}
    .controls-section{margin-bottom:var(--space-12)}
    .controls-grid{display:grid;grid-template-columns:auto 1fr auto;gap:var(--space-8);align-items:center;background:rgba(37,41,68,0.4);border:1px solid var(--border);border-radius:var(--radius-2xl);padding:var(--space-8);box-shadow:0 8px 32px rgba(0,0,0,0.1);backdrop-filter:blur(20px);transition:all var(--duration-300) var(--ease-out)}
    .controls-grid:hover{box-shadow:0 12px 40px rgba(0,0,0,0.15);transform:translateY(-2px)}
    .control-group{display:flex;align-items:center;gap:var(--space-3)}
    .control-label{font-size:var(--font-size-sm);font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em}
    .select-wrapper{position:relative}
    .location-select{appearance:none;background:rgba(30,34,53,0.8);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-3) var(--space-10) var(--space-3) var(--space-4);font-family:inherit;font-size:var(--font-size-sm);font-weight:600;color:var(--text-primary);cursor:pointer;transition:all var(--duration-200) var(--ease-out);min-width:200px;backdrop-filter:blur(10px)}
    .location-select:hover{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1);transform:translateY(-1px)}
    .location-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1);transform:translateY(-1px)}
    .select-wrapper::after{content:'';position:absolute;right:var(--space-4);top:50%;transform:translateY(-50%);width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:4px solid var(--text-secondary);pointer-events:none}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--space-2);padding:var(--space-4) var(--space-6);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:var(--font-size-sm);font-weight:600;text-decoration:none;cursor:pointer;transition:all var(--duration-200) var(--ease-out);position:relative;overflow:hidden}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .btn-primary{background:var(--gradient-primary);color:#fff;box-shadow:0 4px 15px rgba(99,102,241,0.3);position:relative;overflow:hidden}
    .btn-primary::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s}
    .btn-primary:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 25px rgba(99,102,241,0.4)}
    .btn-primary:hover:not(:disabled)::before{left:100%}
    .btn-secondary{background:var(--gradient-secondary);color:#fff;box-shadow:0 4px 15px rgba(20,184,166,0.3);position:relative;overflow:hidden}
    .btn-secondary::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s}
    .btn-secondary:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 25px rgba(20,184,166,0.4)}
    .btn-secondary:hover:not(:disabled)::before{left:100%}
    .btn-accent{background:var(--gradient-warm);color:#fff;box-shadow:0 4px 15px rgba(245,158,11,0.3);position:relative;overflow:hidden}
    .btn-accent::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s}
    .btn-accent:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 25px rgba(245,158,11,0.4)}
    .btn-accent:hover:not(:disabled)::before{left:100%}
    .btn-icon{font-size:var(--font-size-sm)}
    .btn-loading{position:relative;color:transparent!important}
    .btn-loading::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0)}100%{transform:translate(-50%,-50%) rotate(360deg)}}

    .content-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-12);align-items:start;margin-bottom:var(--space-16);position:relative}
    .content-grid::after{content:'';position:absolute;bottom:calc(-1 * var(--space-8));left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);opacity:0.5}
    .content-grid:last-of-type{margin-bottom:0}
    .content-grid-single{grid-template-columns:1fr;max-width:1200px;margin-left:auto;margin-right:auto}
    .panel-wide{max-width:none;width:100%}
    .panel{background:rgba(37,41,68,0.4);border:1px solid var(--border);border-radius:var(--radius-2xl);box-shadow:0 8px 32px rgba(0,0,0,0.1);overflow:hidden;height:600px;display:flex;flex-direction:column;transition:all var(--duration-300) var(--ease-out);backdrop-filter:blur(20px);position:relative}
    .panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(99,102,241,0.5),transparent);opacity:0;transition:opacity var(--duration-300) var(--ease-out)}
    .panel:hover{box-shadow:0 12px 40px rgba(0,0,0,0.15);transform:translateY(-4px)}
    .panel:hover::before{opacity:1}
    .panel-header{padding:var(--space-8);border-bottom:1px solid var(--border);background:rgba(21,24,37,0.6);backdrop-filter:blur(10px)}
    .panel-title{display:flex;align-items:center;gap:var(--space-4);font-size:var(--font-size-xl);font-weight:700;color:var(--text-primary);margin-bottom:var(--space-3)}
    .panel-icon{font-size:var(--font-size-lg);background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .panel-subtitle{font-size:var(--font-size-sm);color:var(--text-muted);font-weight:500;line-height:1.5}
    .panel-content{flex:1;padding:var(--space-8);overflow-y:auto;position:relative;max-height:calc(600px - 120px)}
    .panel-content::-webkit-scrollbar{width:6px}
    .panel-content::-webkit-scrollbar-track{background:var(--bg-tertiary);border-radius:var(--radius-sm)}
    .panel-content::-webkit-scrollbar-thumb{background:var(--gradient-primary);border-radius:var(--radius-sm)}
    .panel-footer{padding:var(--space-8);border-top:1px solid var(--border);background:rgba(21,24,37,0.6);backdrop-filter:blur(10px);display:flex;gap:var(--space-4);align-items:center;justify-content:center}

    .trends-list{display:flex;flex-direction:column;gap:var(--space-5)}
    .trend-item{background:rgba(30,34,53,0.6);border:1px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-6);cursor:pointer;transition:all var(--duration-200) var(--ease-out);position:relative;backdrop-filter:blur(10px)}
    .trend-item:hover{border-color:var(--primary);box-shadow:0 8px 25px rgba(99,102,241,0.2);transform:translateY(-2px);background:rgba(30,34,53,0.8)}
    .trend-item.selected{border-color:var(--primary);background:rgba(99,102,241,0.1);box-shadow:0 8px 25px rgba(99,102,241,0.3);transform:translateY(-1px)}
    .trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-4)}
    .trend-info{display:flex;align-items:center;gap:var(--space-4)}
    .trend-rank{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:var(--gradient-primary);color:#fff;border-radius:var(--radius-lg);font-size:var(--font-size-sm);font-weight:700;box-shadow:0 4px 12px rgba(99,102,241,0.3);transition:all var(--duration-200) var(--ease-out)}
    .trend-rank:hover{transform:scale(1.1);box-shadow:0 6px 16px rgba(99,102,241,0.4)}
    .trend-name{font-size:var(--font-size-lg);font-weight:600;color:var(--text-primary)}
    .trend-count{background:var(--gradient-secondary);color:#fff;padding:var(--space-1) var(--space-3);border-radius:var(--radius-full);font-size:var(--font-size-xs);font-weight:600;font-family:'JetBrains Mono',monospace}
    .trend-description{font-size:var(--font-size-sm);color:var(--text-secondary);line-height:1.5}

    .story-content,.translation-content,.trends-content{background:rgba(30,34,53,0.6);border:1px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-8);font-size:var(--font-size-sm);line-height:1.7;color:var(--text-secondary);white-space:pre-wrap;height:100%;overflow-y:auto;backdrop-filter:blur(10px);transition:all var(--duration-200) var(--ease-out)}
    .story-content:hover,.translation-content:hover,.trends-content:hover{background:rgba(30,34,53,0.8);box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    .translation-content{direction:rtl;text-align:right;font-family:'Noto Nastaliq Urdu','Amiri','Times New Roman',serif}
    .story-content::-webkit-scrollbar,.translation-content::-webkit-scrollbar,.trends-content::-webkit-scrollbar{width:6px}
    .story-content::-webkit-scrollbar-track,.translation-content::-webkit-scrollbar-track,.trends-content::-webkit-scrollbar-track{background:var(--bg-secondary);border-radius:var(--radius-sm)}
    .story-content::-webkit-scrollbar-thumb,.translation-content::-webkit-scrollbar-thumb,.trends-content::-webkit-scrollbar-thumb{background:var(--gradient-primary);border-radius:var(--radius-sm)}

    .translation-toggle{display:flex;background:rgba(30,34,53,0.6);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-1);margin-bottom:var(--space-6);backdrop-filter:blur(10px);box-shadow:0 4px 15px rgba(0,0,0,0.1)}
    .translation-tab{flex:1;padding:var(--space-2) var(--space-4);border:none;background:transparent;color:var(--text-secondary);font-size:var(--font-size-sm);font-weight:600;border-radius:var(--radius-md);cursor:pointer;transition:all var(--duration-200) var(--ease-out)}
    .translation-tab.active{background:var(--gradient-primary);color:#fff;box-shadow:0 4px 12px rgba(99,102,241,0.3);transform:scale(1.02)}
    .translation-tab:hover:not(.active){background:rgba(37,41,68,0.6);transform:translateY(-1px)}

    .empty-state,.loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:var(--space-16);height:100%}
    .empty-icon{font-size:var(--font-size-4xl);color:var(--text-muted);margin-bottom:var(--space-4);opacity:.5;transition:all var(--duration-300) var(--ease-out)}
    .empty-state:hover .empty-icon{opacity:.8;transform:scale(1.1)}
    .empty-title{font-size:var(--font-size-lg);font-weight:600;color:var(--text-secondary);margin-bottom:var(--space-2)}
    .empty-description{font-size:var(--font-size-sm);color:var(--text-muted);max-width:300px;line-height:1.5}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:var(--space-4)}

    /* New: Visual panels specific */
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:var(--space-6)}
    .field label{font-size:var(--font-size-xs);font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em}
    .field input[type="text"],.field input[type="number"],.field textarea,.field select,.field input[type="file"]{background:rgba(30,34,53,0.6);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px 16px;color:var(--text-primary);font-size:var(--font-size-sm);transition:all var(--duration-200) var(--ease-out);backdrop-filter:blur(10px);appearance:none}
    .field input[type="text"]:focus,.field input[type="number"]:focus,.field textarea:focus,.field select:focus,.field input[type="file"]:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1);background:rgba(30,34,53,0.8);transform:translateY(-1px)}
    .field input[type="text"]:hover,.field input[type="number"]:hover,.field textarea:hover,.field select:hover,.field input[type="file"]:hover{background:rgba(30,34,53,0.7);border-color:var(--primary)}
    .field select{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");background-position:right 12px center;background-repeat:no-repeat;background-size:16px;padding-right:40px}
    .field input[type="file"]{cursor:pointer;padding:8px 12px}
    .field input[type="file"]::-webkit-file-upload-button{background:var(--gradient-primary);color:#fff;border:none;border-radius:var(--radius-md);padding:6px 12px;margin-right:12px;font-size:var(--font-size-xs);font-weight:600;cursor:pointer;transition:all var(--duration-200) var(--ease-out)}
    .field input[type="file"]::-webkit-file-upload-button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(99,102,241,0.3)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-6)}
    .switch{display:flex;align-items:center;gap:10px}
    .small{font-size:var(--font-size-xs);color:var(--text-muted)}
    .thumb{width:100%;border-radius:var(--radius-xl);border:1px solid var(--border);background:rgba(30,34,53,0.6);display:block;transition:all var(--duration-200) var(--ease-out);backdrop-filter:blur(10px)}
    .thumb:hover{box-shadow:0 8px 25px rgba(0,0,0,0.2);transform:scale(1.02)}
    .video{width:100%;border-radius:var(--radius-xl);border:1px solid var(--border);background:#000;display:block;transition:all var(--duration-200) var(--ease-out)}
    .video:hover{box-shadow:0 8px 25px rgba(0,0,0,0.3);transform:scale(1.01)}

    /* Batch Generation Specific Styles */
    .batch-controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-12);height:100%}
    .batch-section{display:flex;flex-direction:column;gap:var(--space-6)}
    .section-title{display:flex;align-items:center;gap:var(--space-3);font-size:var(--font-size-lg);font-weight:600;color:var(--text-primary);margin-bottom:var(--space-4);padding-bottom:var(--space-3);border-bottom:2px solid var(--border);position:relative}
    .section-title::after{content:'';position:absolute;bottom:-2px;left:0;width:40px;height:2px;background:var(--gradient-primary);border-radius:var(--radius-full)}
    .section-title i{background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:var(--font-size-base)}
    .batch-images-container{min-height:300px;background:rgba(30,34,53,0.3);border:2px dashed var(--border);border-radius:var(--radius-xl);padding:var(--space-8);display:flex;align-items:center;justify-content:center;transition:all var(--duration-300) var(--ease-out)}
    .batch-images-container:hover{border-color:var(--primary);background:rgba(30,34,53,0.4)}
    .empty-batch-state{text-align:center;color:var(--text-muted)}
    .empty-batch-state .empty-icon{font-size:var(--font-size-3xl);margin-bottom:var(--space-4);opacity:0.6}
    .empty-batch-state .empty-title{font-size:var(--font-size-lg);font-weight:600;color:var(--text-secondary);margin-bottom:var(--space-2)}
    .empty-batch-state .empty-description{font-size:var(--font-size-sm);line-height:1.5;max-width:250px;margin:0 auto}
    .batch-images-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-4);width:100%}
    .batch-images-grid img{width:100%;height:auto;border-radius:var(--radius-lg);border:2px solid var(--border);transition:all var(--duration-200) var(--ease-out)}
    .batch-images-grid img:hover{border-color:var(--primary);transform:scale(1.02);box-shadow:0 8px 25px rgba(99,102,241,0.2)}

    .notification{position:fixed;top:var(--space-6);right:var(--space-6);background:rgba(37,41,68,0.9);border:1px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-4) var(--space-5);box-shadow:0 20px 40px rgba(0,0,0,0.3);backdrop-filter:blur(20px);max-width:400px;z-index:1000;transform:translateX(calc(100% + var(--space-6)));transition:transform var(--duration-300) var(--ease-out)}
    .notification.show{transform:translateX(0)}
    .notification-content{display:flex;align-items:flex-start;gap:var(--space-3)}
    .notification-icon{flex-shrink:0;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:var(--font-size-xs);color:#fff;margin-top:var(--space-1)}
    .notification.success .notification-icon{background:var(--success)}
    .notification.error .notification-icon{background:var(--error)}
    .notification.warning .notification-icon{background:var(--warning)}
    .notification.info .notification-icon{background:var(--info)}
    .notification-text{font-size:var(--font-size-sm);color:var(--text-primary);font-weight:500;line-height:1.4}

    /* Responsive */
    @media (max-width:1200px){
      .app-main{max-width:100%;padding:var(--space-10) var(--space-6)}
    }
    @media (max-width:1024px){
      .content-grid{grid-template-columns:1fr;gap:var(--space-10)}
      .panel{height:600px}
      .status-grid{grid-template-columns:repeat(3,1fr)}
      .app-main{padding:var(--space-8) var(--space-6)}
      .batch-controls-grid{grid-template-columns:1fr;gap:var(--space-8)}
      .content-grid-single{max-width:100%}
    }
    @media (max-width:768px){
      .header-content{padding:var(--space-6);flex-direction:column;gap:var(--space-6)}
      .status-grid{grid-template-columns:1fr;gap:var(--space-3)}
      .app-main{padding:var(--space-6) var(--space-4)}
      .controls-grid{grid-template-columns:1fr;gap:var(--space-6);text-align:center;padding:var(--space-6)}
      .location-select{min-width:auto;width:100%}
      .logo{font-size:var(--font-size-2xl)}.tagline{display:none}
      .panel{height:500px}
      .panel-content{padding:var(--space-6);max-height:calc(500px - 100px)}
      .panel-header,.panel-footer{padding:var(--space-6)}
      .panel-footer{flex-direction:column;gap:var(--space-3)}
      .row{grid-template-columns:1fr;gap:var(--space-4)}
      .content-grid{gap:var(--space-8)}
      .batch-controls-grid{grid-template-columns:1fr;gap:var(--space-6)}
      .batch-images-container{min-height:250px;padding:var(--space-6)}
      .batch-images-grid{grid-template-columns:1fr;gap:var(--space-3)}
    }
    @media (max-width:480px){
      .app-main{padding:var(--space-4) var(--space-3)}
      .controls-grid{padding:var(--space-4)}
      .trend-item{padding:var(--space-4)}
      .story-content,.translation-content,.trends-content{padding:var(--space-4)}
      .panel-content{padding:var(--space-4)}
      .panel-header,.panel-footer{padding:var(--space-4)}
      .content-grid{gap:var(--space-6)}
    }

    /* Animations & Utilities */
    .fade-in{animation:fadeIn .4s var(--ease-out)}
    .slide-up{animation:slideUp .4s var(--ease-out)}
    .scale-in{animation:scaleIn .3s var(--ease-out)}
    .float{animation:float 3s ease-in-out infinite}
    .glow{animation:glow 2s ease-in-out infinite alternate}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    @keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-10px)}}
    @keyframes glow{from{box-shadow:0 0 20px rgba(99,102,241,0.3)}to{box-shadow:0 0 30px rgba(99,102,241,0.6)}}
    .btn:focus-visible,.location-select:focus-visible,.theme-toggle:focus-visible,.translation-tab:focus-visible{outline:2px solid var(--primary);outline-offset:2px}
    .trend-item:focus-visible{outline:2px solid var(--primary);outline-offset:2px}
    h1,h2,h3,h4,h5,h6{font-family:var(--font-family-display);font-weight:700;line-height:1.2;color:var(--text-primary)}
    p{line-height:1.6;color:var(--text-secondary)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .text-gradient{background:var(--gradient-brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  </style>
</head>
<body data-theme="dark">
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="header-content">
        <div class="brand">
          <h1 class="logo">Reelify</h1>
          <span class="tagline">AI-Powered Story Generation</span>
        </div>

        <div class="header-controls">
          <div class="status-grid">
            <div class="status-item"><div class="status-dot loading" id="geminiStatus"></div><span>Gemini</span></div>
            <div class="status-item"><div class="status-dot loading" id="scraperStatus"></div><span>Scraper</span></div>
            <div class="status-item"><div class="status-dot loading" id="translatorStatus"></div><span>Translator</span></div>
            <div class="status-item"><div class="status-dot loading" id="t2iStatus"></div><span>SDXL</span></div>
            <div class="status-item"><div class="status-dot loading" id="i2vStatus"></div><span>SVD</span></div>
          </div>

          <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
            <i class="fas fa-sun theme-icon sun"></i>
            <i class="fas fa-moon theme-icon moon"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="app-main">
      <!-- Controls -->
      <section class="controls-section">
        <div class="controls-grid">
          <div class="control-group">
            <label class="control-label" for="locationSelect">Region</label>
            <div class="select-wrapper">
              <select class="location-select" id="locationSelect">
                <option value="pakistan">üáµüá∞ Pakistan</option>
                <option value="united-states">üá∫üá∏ United States</option>
              </select>
            </div>
          </div>

          <div style="justify-self:center;"></div>

          <div style="justify-self:end;">
            <button class="btn btn-primary" id="scrapeBtn">
              <i class="fas fa-download btn-icon"></i><span>Scrape Latest Trends</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Top Grid: Trends + Story -->
      <div class="content-grid">
        <!-- Trends Panel -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title"><i class="fas fa-chart-line panel-icon"></i>Trending Topics</div>
            <div class="panel-subtitle" id="trendsCount">Select a region to fetch trends</div>
          </div>
          <div class="panel-content">
            <div class="trends-content" id="trendsContainer">
              <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="empty-title">No Trends Available</div>
                <div class="empty-description">Select a region and click "Scrape Latest Trends" to fetch current trending topics</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Story Panel -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title"><i class="fas fa-feather-alt panel-icon"></i>Generated Story</div>
            <div class="panel-subtitle" id="storyStatus">Ready to generate</div>
          </div>

          <div class="panel-content">
            <div class="translation-toggle" id="translationToggle" style="display:none;">
              <button class="translation-tab active" id="englishTab"><i class="fas fa-flag-usa"></i> English</button>
              <button class="translation-tab" id="urduTab"><i class="fas fa-flag"></i> ÿßÿ±ÿØŸà</button>
            </div>

            <div class="story-content" id="storyContent">
              <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-pen-fancy"></i></div>
                <div class="empty-title">Ready to Create</div>
                <div class="empty-description">Select a trending topic and click "Generate Story"</div>
              </div>
            </div>

            <div class="translation-content" id="translationContent" style="display:none;">
              <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-language"></i></div>
                <div class="empty-title">Translation Ready</div>
                <div class="empty-description">Click "Translate to Urdu" to get the Urdu version</div>
              </div>
            </div>
            <div class="story-meta-container" id="storyMetaContainer"></div>
          </div>

          <div class="panel-footer" id="storyFooter" style="display:none;">
            <button class="btn btn-secondary" id="generateBtn" disabled>
              <i class="fas fa-magic btn-icon"></i><span>Generate Story</span>
            </button>
            <button class="btn btn-accent" id="translateBtn" disabled>
              <i class="fas fa-language btn-icon"></i><span>Translate to Urdu</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Bottom Grid: Text‚ÜíImage + Image‚ÜíVideo -->
      <div class="content-grid">
        <!-- Text to Image Panel -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title"><i class="fas fa-image panel-icon"></i>Text ‚Üí Image (SDXL Base 1.0)</div>
            <div class="panel-subtitle" id="t2iStatusText">High-quality image generation with memory optimization</div>
          </div>

          <div class="panel-content">
            <div class="field">
              <label for="t2iPrompt">Prompt</label>
              <textarea id="t2iPrompt" rows="4" placeholder="Leave empty to auto-derive from the last story/trend..."></textarea>
              <div class="small">Tip: Describe scene, mood, and details. Example: ‚ÄúIslamabad skyline at golden hour, cinematic b-roll, dramatic clouds, depth of field‚Äù</div>
            </div>

            <div class="row">
              <div class="field">
                <label for="negativePrompt">Negative Prompt (optional)</label>
                <input type="text" id="negativePrompt" placeholder="e.g., blurry, low quality, watermark"/>
              </div>
              <div class="field">
                <label for="basePromptPrefix">Base Prompt Prefix (optional)</label>
                <input type="text" id="basePromptPrefix" placeholder="e.g., Professional Pakistani news broadcast"/>
              </div>
            </div>

            <details class="field">
              <summary style="cursor:pointer;font-weight:700;">Advanced</summary>
              <div class="row" style="margin-top: var(--space-4);">
                <div class="field"><label for="width">Width</label><input type="number" id="width" min="256" step="64" value="1024"></div>
                <div class="field"><label for="height">Height</label><input type="number" id="height" min="256" step="64" value="1024"></div>
              </div>
              <div class="row">
                <div class="field"><label for="steps">Steps</label><input type="number" id="steps" min="1" max="75" value="30"></div>
                <div class="field"><label for="guidance">Guidance Scale</label><input type="number" id="guidance" min="0" max="15" step="0.1" value="5.5"></div>
              </div>
              <div class="field"><label for="seed">Seed (optional)</label><input type="number" id="seed" placeholder="Leave blank for random"></div>
            </details>

            <div class="field">
              <img id="generatedImage" alt="Generated image preview" class="thumb" style="display:none;"/>
              <div id="imagePath" class="small" style="margin-top:6px;"></div>
            </div>
          </div>

          <div class="panel-footer">
            <button class="btn btn-secondary" id="generateImageBtn">
              <i class="fas fa-wand-magic-sparkles btn-icon"></i><span>Generate Image (Ctrl+I)</span>
            </button>
            <button class="btn btn-primary" id="useImageForVideoBtn" disabled>
              <i class="fas fa-video btn-icon"></i><span>Use This Image in Video</span>
            </button>
          </div>
        </div>

      <!-- Bottom Section: Batch Image Generation -->
      <div class="content-grid content-grid-single">
        <!-- Batch Image Generation Panel -->
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title"><i class="fas fa-images panel-icon"></i>Batch Image Generation</div>
            <div class="panel-subtitle">Generate multiple scene images from your story for creating engaging reels</div>
          </div>

          <div class="panel-content">
            <div class="batch-controls-grid">
              <div class="batch-section">
                <h3 class="section-title"><i class="fas fa-cog"></i> Generation Settings</h3>
                <div class="field">
                  <label for="batchCount">Number of Scenes</label>
                  <input type="number" id="batchCount" min="2" max="6" value="4">
                  <div class="small">Recommended: 4 scenes for a good reel</div>
                </div>

                <div class="field">
                  <label for="batchBasePrefix">Base Prompt Prefix</label>
                  <input type="text" id="batchBasePrefix" placeholder="Professional Pakistani news broadcast, high quality, cinematic">
                  <div class="small">This will be added to all generated scene prompts</div>
                </div>

                <div class="row">
                  <div class="field">
                    <label for="batchSteps">Steps</label>
                    <input type="number" id="batchSteps" min="20" max="50" value="30">
                  </div>
                  <div class="field">
                    <label for="batchGuidance">Guidance Scale</label>
                    <input type="number" id="batchGuidance" min="5" max="10" step="0.1" value="5.5">
                  </div>
                </div>
              </div>

              <div class="batch-section">
                <h3 class="section-title"><i class="fas fa-images"></i> Generated Images</h3>
                <div class="field">
                  <div id="batchImages" class="batch-images-container">
                    <div class="empty-batch-state">
                      <div class="empty-icon"><i class="fas fa-image"></i></div>
                      <div class="empty-title">No Images Generated</div>
                      <div class="empty-description">Click "Generate Scene Images" to create images from your story</div>
                    </div>
                    <div id="batchImagesList" class="batch-images-grid" style="display: none;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel-footer">
            <button class="btn btn-secondary" id="generateBatchBtn">
              <i class="fas fa-layer-group btn-icon"></i><span>Generate Scene Images</span>
            </button>
            <button class="btn btn-primary" id="useBatchForReelBtn" disabled>
              <i class="fas fa-video btn-icon"></i><span>Create Reel from These</span>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <div class="notification-icon" id="notificationIcon"><i class="fas fa-check"></i></div>
      <div class="notification-text" id="notificationText"></div>
    </div>
  </div>

  <script>
    /* Theme Manager */
    class ThemeManager {
      constructor(){this.currentTheme=localStorage.getItem('theme')||'dark';this.init()}
      init(){this.applyTheme(this.currentTheme);this.bindEvents()}
      applyTheme(t){document.body.setAttribute('data-theme',t);const e=document.getElementById('themeToggle');if(e){e.classList.toggle('active',t==='light')}localStorage.setItem('theme',t);this.currentTheme=t}
      toggleTheme(){this.applyTheme(this.currentTheme==='dark'?'light':'dark')}
      bindEvents(){const t=document.getElementById('themeToggle');if(t){t.addEventListener('click',()=>this.toggleTheme())}}
    }

    /* App State */
    class AppState {
      constructor(){
        this.trends=[];this.selectedTrend=null;
        this.isGenerating=false;this.isTranslating=false;this.isLoading=false;
        this.isGeneratingImage=false;this.isGeneratingVideo=false;this.isGeneratingBatch=false;this.isGeneratingReel=false;
        this.currentLocation='pakistan';this.currentStory=null;this.currentTranslation=null;this.currentView='english';
        this.lastImageUrl=null;this.lastVideoUrl=null;this.lastBatchImages=[];this.lastReelUrl=null;
        this.systemStatus={gemini:true,scraper:true,translator:true,t2i:false,i2v:false};
      }
      setTrends(t){this.trends=t;this.selectedTrend=null;this.currentStory=null;this.currentTranslation=null;this.updateUI()}
      selectTrend(i){document.querySelectorAll('.trend-item').forEach(x=>x.classList.remove('selected'));this.selectedTrend=this.trends[i];this.updateUI();const els=document.querySelectorAll('.trend-item');if(els[i])els[i].classList.add('selected')}
      setGenerating(v){this.isGenerating=v;this.updateUI()}
      setTranslating(v){this.isTranslating=v;this.updateUI()}
      setGeneratingImage(v){this.isGeneratingImage=v;this.updateImageButtons()}
      setGeneratingVideo(v){this.isGeneratingVideo=v;this.updateVideoButtons()}
      setGeneratingBatch(v){this.isGeneratingBatch=v;this.updateBatchButtons()}
      setGeneratingReel(v){this.isGeneratingReel=v;this.updateReelButtons()}
      setLoading(v){this.isLoading=v;this.updateUI()}
      setStory(s){
      this.currentStory = s;
      localStorage.setItem('last_story', s);   // ‚úÖ persist
      this.currentTranslation = null;
      this.currentView = 'english';
      this.updateUI();
      }

      setTranslation(t){this.currentTranslation=t;this.updateUI()}
      setView(v){this.currentView=v;this.updateViewDisplay()}
      setLastImage(url){this.lastImageUrl=url;document.getElementById('generatedImage').src=url;document.getElementById('generatedImage').style.display='block';document.getElementById('imagePath').textContent=url;document.getElementById('useImageForVideoBtn').disabled=false}
      setLastVideo(url){this.lastVideoUrl=url;const v=document.getElementById('generatedVideo');v.src=url;v.style.display='block';document.getElementById('videoPath').textContent=url}
      setLastBatchImages(images){this.lastBatchImages=images;this.updateBatchImagesDisplay();document.getElementById('useBatchForReelBtn').disabled=false}
      setLastReel(url){this.lastReelUrl=url;const v=document.getElementById('generatedReel');v.src=url;v.style.display='block';document.getElementById('reelPath').textContent=url}
      updateSystemStatus(s){this.systemStatus={...this.systemStatus,...s};this.updateStatusIndicators()}
      updateUI(){this.updateTrendsDisplay();this.updateGenerateButton();this.updateTranslateButton();this.updateStoryFooter()}
      updateTrendsDisplay(){
        const c=document.getElementById('trendsContainer');const count=document.getElementById('trendsCount');
        if(this.trends.length===0){c.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="fas fa-chart-bar"></i></div><div class="empty-title">No Trends Available</div><div class="empty-description">Select a region and click "Scrape Latest Trends"</div></div>`;count.textContent='Select a region to fetch trends';return}
        count.textContent=`${this.trends.length} trending topics found`;
        const html=this.trends.map((t,i)=>`
          <div class="trend-item fade-in ${this.selectedTrend===t?'selected':''}" onclick="appState.selectTrend(${i})" tabindex="0" role="button" aria-label="Select trend: ${t.name}" style="animation-delay:${i*0.05}s">
            <div class="trend-header">
              <div class="trend-info">
                <div class="trend-rank">${t.rank}</div>
                <div class="trend-name">${t.name}</div>
              </div>
              <div class="trend-count">${t.count}</div>
            </div>
            <div class="trend-description">${t.description||'Loading description...'}</div>
          </div>`).join('');
        c.innerHTML=`<div class="trends-list">${html}</div>`;
        document.querySelectorAll('.trend-item').forEach((item,idx)=>{item.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.selectTrend(idx)}})})
      }
      updateGenerateButton(){
        const btn=document.getElementById('generateBtn');const icon=btn.querySelector('.btn-icon');const text=btn.querySelector('span');btn.classList.remove('btn-loading');
        if(this.isGenerating){btn.disabled=true;btn.classList.add('btn-loading');text.textContent='Generating...'}
        else if(!this.selectedTrend){btn.disabled=true;icon.className='fas fa-hand-pointer btn-icon';text.textContent='Select a Trend'}
        else{btn.disabled=false;icon.className='fas fa-magic btn-icon';text.textContent='Generate Story'}
      }
      updateTranslateButton(){
        const btn=document.getElementById('translateBtn');const icon=btn.querySelector('.btn-icon');const text=btn.querySelector('span');btn.classList.remove('btn-loading');
        if(this.isTranslating){btn.disabled=true;btn.classList.add('btn-loading');text.textContent='Translating...'}
        else if(!this.currentStory){btn.disabled=true;icon.className='fas fa-file-text btn-icon';text.textContent='Generate Story First'}
        else if(this.currentTranslation){btn.disabled=false;icon.className='fas fa-sync btn-icon';text.textContent='Retranslate'}
        else{btn.disabled=false;icon.className='fas fa-language btn-icon';text.textContent='Translate to Urdu'}
      }
      updateStoryFooter(){
        const footer=document.getElementById('storyFooter');const toggle=document.getElementById('translationToggle');
        footer.style.display=this.selectedTrend?'flex':'none';
        toggle.style.display=(this.currentStory&&this.currentTranslation)?'flex':'none';
      }
      updateViewDisplay(){
        const en=document.getElementById('englishTab'), ur=document.getElementById('urduTab'), sc=document.getElementById('storyContent'), tc=document.getElementById('translationContent');
        if(this.currentView==='english'){en.classList.add('active');ur.classList.remove('active');sc.style.display='block';tc.style.display='none'}
        else{en.classList.remove('active');ur.classList.add('active');sc.style.display='none';tc.style.display='block'}
      }
      updateStatusIndicators(){
        const s=this.systemStatus;
        const set=(id,val)=>{const el=document.getElementById(id);if(el){el.className=`status-dot ${val?'online':'offline'}`}}
        set('geminiStatus',s.gemini);
        set('scraperStatus',s.scraper);
        set('translatorStatus',s.translator);
        set('t2iStatus',s.t2i);
        set('i2vStatus',s.i2v);
        const t2iText=document.getElementById('t2iStatusText'); if(t2iText) t2iText.textContent = s.t2i?'Ready':'Not loaded yet (first call may take time)';
        const i2vText=document.getElementById('i2vStatusText'); if(i2vText) i2vText.textContent = s.i2v?'Ready':'Not loaded yet (first call may take time)';
      }
      updateImageButtons(){
        const btn=document.getElementById('generateImageBtn');btn.classList.remove('btn-loading');
        if(this.isGeneratingImage){btn.disabled=true;btn.classList.add('btn-loading')}
        else{btn.disabled=false}
      }
      updateVideoButtons(){
        const btn=document.getElementById('generateVideoBtn');btn.classList.remove('btn-loading');
        if(this.isGeneratingVideo){btn.disabled=true;btn.classList.add('btn-loading')}
        else{btn.disabled=false}
      }
      updateBatchButtons(){
        const btn=document.getElementById('generateBatchBtn');btn.classList.remove('btn-loading');
        if(this.isGeneratingBatch){btn.disabled=true;btn.classList.add('btn-loading')}
        else{btn.disabled=false}
      }
      updateReelButtons(){
        const btn=document.getElementById('generateReelBtn');btn.classList.remove('btn-loading');
        if(this.isGeneratingReel){btn.disabled=true;btn.classList.add('btn-loading')}
        else{btn.disabled=false}
      }
      updateBatchImagesDisplay(){
        const container=document.getElementById('batchImages');const list=document.getElementById('batchImagesList');
        if(this.lastBatchImages.length===0){
          container.querySelector('.empty-batch-state').style.display='block';
          list.style.display='none';
          return
        }
        container.querySelector('.empty-batch-state').style.display='none';
        list.style.display='grid';
        list.innerHTML=this.lastBatchImages.map((url,i)=>`<img src="${url}" alt="Scene ${i+1}" class="thumb">`).join('')
      }
    }

    /* Notifications */
    class NotificationManager{
      show(msg,type='success',dur=4000){const n=document.getElementById('notification'),t=document.getElementById('notificationText'),i=document.getElementById('notificationIcon');const icons={success:'fas fa-check',error:'fas fa-times',warning:'fas fa-exclamation-triangle',info:'fas fa-info'};i.innerHTML=`<i class="${icons[type]}"></i>`;t.textContent=msg;n.className=`notification ${type} show`;setTimeout(()=>n.classList.remove('show'),dur)}
      success(m,d){this.show(m,'success',d)} error(m,d){this.show(m,'error',d)} warning(m,d){this.show(m,'warning',d)} info(m,d){this.show(m,'info',d)}
    }

    /* API Client */
    class APIClient{
      async scrapeTrends(location){const r=await fetch('/api/scrape-trends',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location})});if(!r.ok)throw new Error(r.status);return await r.json()}
      async generateStory(tag,description){const r=await fetch('/api/generate-story',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tag,description})});if(!r.ok)throw new Error(r.status);return await r.json()}
      async translateStory(text=null){const r=await fetch('/api/translate-story',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});if(!r.ok)throw new Error(r.status);return await r.json()}
      async checkHealth(){try{const r=await fetch('/api/health');if(!r.ok)throw new Error(r.status);return await r.json()}catch(e){console.error('health error',e);return null}}
      async generateImage(payload){const r=await fetch('/api/generate-image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!r.ok)throw new Error(r.status);return await r.json()}
      async generateImages(payload){const r=await fetch('/api/generate-images',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!r.ok)throw new Error(r.status);return await r.json()}
      async imageToVideo(payload){const r=await fetch('/api/image-to-video',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!r.ok)throw new Error(r.status);return await r.json()}
      async generateReel(payload){const r=await fetch('/api/generate-reel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!r.ok)throw new Error(r.status);return await r.json()}
    }

    /* Instances & DOM */
    const themeManager=new ThemeManager();
    const appState=new AppState();
    const notifications=new NotificationManager();
    const apiClient=new APIClient();

    const locationSelect=document.getElementById('locationSelect');
    const scrapeBtn=document.getElementById('scrapeBtn');
    const generateBtn=document.getElementById('generateBtn');
    const translateBtn=document.getElementById('translateBtn');
    const englishTab=document.getElementById('englishTab');
    const urduTab=document.getElementById('urduTab');
    const storyContent=document.getElementById('storyContent');
    const translationContent=document.getElementById('translationContent');
    const storyStatus=document.getElementById('storyStatus');

    // T2I
    const t2iPrompt=document.getElementById('t2iPrompt');
    const preferTurbo=document.getElementById('preferTurbo');
    const negativePrompt=document.getElementById('negativePrompt');
    const width=document.getElementById('width');
    const height=document.getElementById('height');
    const steps=document.getElementById('steps');
    const guidance=document.getElementById('guidance');
    const seed=document.getElementById('seed');
    const generatedImage=document.getElementById('generatedImage');
    const imagePath=document.getElementById('imagePath');
    const generateImageBtn=document.getElementById('generateImageBtn');
    const useImageForVideoBtn=document.getElementById('useImageForVideoBtn');

    // I2V
    const fps=document.getElementById('fps');
    const numFrames=document.getElementById('numFrames');
    const motionBucket=document.getElementById('motionBucket');
    const noiseAug=document.getElementById('noiseAug');
    const imageSrc=document.getElementById('imageSrc');
    const imageUpload=document.getElementById('imageUpload');
    const generatedVideo=document.getElementById('generatedVideo');
    const videoPath=document.getElementById('videoPath');
    const generateVideoBtn=document.getElementById('generateVideoBtn');
    const useLastImageBtn=document.getElementById('useLastImageBtn');

    // Batch & Reel
    const batchCount=document.getElementById('batchCount');
    const batchBasePrefix=document.getElementById('batchBasePrefix');
    const batchSteps=document.getElementById('batchSteps');
    const batchGuidance=document.getElementById('batchGuidance');
    const generateBatchBtn=document.getElementById('generateBatchBtn');
    const useBatchForReelBtn=document.getElementById('useBatchForReelBtn');
    const reelFps=document.getElementById('reelFps');
    const reelSecondsPerClip=document.getElementById('reelSecondsPerClip');
    const reelMotionBucket=document.getElementById('reelMotionBucket');
    const reelNoiseAug=document.getElementById('reelNoiseAug');
    const reelTarget=document.getElementById('reelTarget');
    const reelMusic=document.getElementById('reelMusic');
    const generateReelBtn=document.getElementById('generateReelBtn');

    /* Helpers */
    function deriveDefaultPrompt(){
      const trend=appState.selectedTrend || (appState.trends && appState.trends[0]);
      const name=trend?trend.name:'news highlight';
      const story=appState.currentStory || '';
      return `Pakistan news visual, cinematic b-roll for: ${name}. Key scene: ${story?story.slice(0,180):'anchor intro with dynamic lower thirds and city skyline'}.`;
    }
    function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}

    function updateStoryMeta(evaluation, evidenceArticles, evidenceCountFromApi){
      const container = document.getElementById('storyMetaContainer');
      if (!container) return;

      const evidence = evidenceArticles || [];
      const evidenceCount = typeof evidenceCountFromApi === 'number'
      ? evidenceCountFromApi
      : evidence.length;

      const verified = evidenceCount > 0;
      const overall = evaluation && typeof evaluation.overall_score === 'number'
      ? evaluation.overall_score
      : null;
      const overallPct = overall !== null ? Math.round(overall * 100) : null;

  // If nothing to show yet, clear.
      if (!verified && overall === null) {
        container.innerHTML = '';
        return;
     }

      let badgeHtml = '';
      if (verified) {
      badgeHtml = `
       <div class="story-meta story-meta-verified">
        <div class="story-meta-header">
          <span class="story-meta-badge">
            <i class="fas fa-shield-check"></i>
            Verified story
          </span>
          ${
            overallPct !== null
              ? `<span class="story-meta-score">Overall score: ${overall.toFixed(3)} (${overallPct}%)</span>`
              : ''
          }
        </div>
        <p class="story-meta-note">
          Grounded in ${evidenceCount} external news source${evidenceCount > 1 ? 's' : ''}. 
          Factual details are constrained to those reports.
        </p>
      </div>
    `;
  } else {
    badgeHtml = `
      <div class="story-meta story-meta-unverified">
        <div class="story-meta-header">
          <span class="story-meta-badge">
            <i class="fas fa-exclamation-triangle"></i>
            Unverified story
          </span>
          ${
            overallPct !== null
              ? `<span class="story-meta-score">Overall score: ${overall.toFixed(3)} (${overallPct}%)</span>`
              : ''
          }
        </div>
        <p class="story-meta-note">
          No external news articles were found for this topic. 
          Treat this as unverified and avoid presenting it as confirmed reporting.
        </p>
      </div>
    `;
  }

  let sourcesHtml = '';
  if (verified) {
    const items = evidence.map((art, idx) => {
      const title = art.title || 'Untitled source';
      const src = art.source_name || 'Unknown source';
      const rawDate = art.published_at;
      let dateStr = '';
      if (rawDate) {
        try {
          dateStr = new Date(rawDate).toLocaleString();
        } catch (_) {}
      }
      const url = art.url || '#';
      return `
        <li class="story-source-item">
          <span class="story-source-index">#${idx + 1}</span>
          <div class="story-source-main">
            <a href="${url}" target="_blank" rel="noopener noreferrer" class="story-source-title">
              ${title}
            </a>
            <div class="story-source-meta">
              ${src}${dateStr ? ` ‚Ä¢ ${dateStr}` : ''}
            </div>
          </div>
        </li>
      `;
    }).join('');

    sourcesHtml = `
      <div class="story-sources">
        <div class="story-sources-title">
          <i class="fas fa-newspaper"></i>
          Sources used to ground this story
        </div>
        <ul class="story-sources-list">
          ${items}
        </ul>
      </div>
    `;
  }

  container.innerHTML = badgeHtml + sourcesHtml;
}

    /* Handlers: Trends / Story / Translation */
    async function handleScrapeTrends(){
      if(appState.isLoading)return;
      const btnIcon=scrapeBtn.querySelector('.btn-icon');const btnText=scrapeBtn.querySelector('span');
      appState.setLoading(true);scrapeBtn.disabled=true;scrapeBtn.classList.add('btn-loading');btnText.textContent='Scraping...';
      try{
        const result=await apiClient.scrapeTrends(locationSelect.value);
        if(result.success){appState.setTrends(result.trends);appState.currentLocation=locationSelect.value;notifications.success(`Fetched ${result.count} trends`)}
        else{throw new Error(result.error||'Failed')}
      }catch(e){notifications.error('Failed to scrape trends. Try again.');console.error(e)}
      finally{appState.setLoading(false);scrapeBtn.disabled=false;scrapeBtn.classList.remove('btn-loading');btnIcon.className='fas fa-download btn-icon';btnText.textContent='Scrape Latest Trends'}
    }
    async function handleGenerateStory(){
      if(!appState.selectedTrend||appState.isGenerating)return;
      const trend=appState.selectedTrend;
      appState.setGenerating(true);storyStatus.textContent=`Generating story for: ${trend.name}`;
      storyContent.innerHTML=`<div class="loading-state"><div class="spinner"></div><div class="loading-text">Crafting your story...</div></div>`;
      try{
        const r=await apiClient.generateStory(trend.name,trend.description);
        if(r.success){
          storyContent.textContent=r.story;appState.setStory(r.story);
          updateStoryMeta(
            r.evaluation || null,
            r.evidence_articles || [],
            typeof r.evidence_count === 'number' ? r.evidence_count : undefined
            );

          storyStatus.textContent=`Generated using ${r.model_used} ‚Ä¢ ${new Date().toLocaleTimeString()}`;
          notifications.success('Story generated')}
        else{throw new Error(r.error||'Failed')}
      }catch(e){
        storyContent.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-title">Generation Failed</div><div class="empty-description">Please try again.</div></div>`;
        storyStatus.textContent='Generation failed';notifications.error('Failed to generate story');console.error(e)
      }finally{appState.setGenerating(false)}
    }
    async function handleTranslateStory(){
      if(!appState.currentStory||appState.isTranslating)return;
      appState.setTranslating(true);storyStatus.textContent='Translating story to Urdu...';
      translationContent.innerHTML=`<div class="loading-state"><div class="spinner"></div><div class="loading-text">Translating...</div></div>`;
      try{
        const r=await apiClient.translateStory(appState.currentStory);
        if(r.success){translationContent.textContent=r.translated_text;appState.setTranslation(r.translated_text);storyStatus.textContent=`Translated ‚Ä¢ ${new Date().toLocaleTimeString()}`;notifications.success('Translated to Urdu');appState.setView('urdu')}
        else{throw new Error(r.error||'Failed')}
      }catch(e){
        translationContent.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-title">Translation Failed</div><div class="empty-description">Model may be loading. Try again.</div></div>`;
        storyStatus.textContent='Translation failed';notifications.error('Translation failed');console.error(e)
      }finally{appState.setTranslating(false)}
    }

    /* Handlers: T2I */
    async function handleGenerateImage(){
      if(appState.isGeneratingImage)return;
      appState.setGeneratingImage(true);
      const payload={
        prompt: (t2iPrompt.value&&t2iPrompt.value.trim())||null,
        negative_prompt: negativePrompt.value||null,
        width: parseInt(width.value||1024,10),
        height: parseInt(height.value||1024,10),
        steps: parseInt(steps.value||30,10),
        guidance_scale: parseFloat(guidance.value||5.5),
        seed: seed.value?parseInt(seed.value,10):null
      };
      if(!payload.prompt){payload.prompt=deriveDefaultPrompt()}
      try{
        const r=await apiClient.generateImage(payload);
        if(r.success){
          appState.setLastImage(r.image_url);
          notifications.success('Image generated');
        }else{throw new Error(r.error||'Image generation failed')}
      }catch(e){notifications.error('Image generation failed');console.error(e)}
      finally{appState.setGeneratingImage(false)}
    }
    function useImageForVideo(){
      if(!appState.lastImageUrl){notifications.warning('No image available. Generate one first.');return}
      imageSrc.value=appState.lastImageUrl;
      notifications.info('Using last generated image for video');
    }

    /* Handlers: I2V */
    async function handleGenerateVideo(){
      if(appState.isGeneratingVideo)return;
      appState.setGeneratingVideo(true);
      const payload={
        image: imageSrc.value||null,
        fps: parseInt(fps.value||7,10),
        motion_bucket_id: parseInt(motionBucket.value||127,10),
        noise_aug_strength: parseFloat(noiseAug.value||0.02),
        num_frames: parseInt(numFrames.value||14,10)
      };
      try{
        const r=await apiClient.imageToVideo(payload);
        if(r.success){
          appState.setLastVideo(r.video_url);
          notifications.success('Video generated');
        }else{throw new Error(r.error||'Video generation failed')}
      }catch(e){notifications.error('Video generation failed');console.error(e)}
      finally{appState.setGeneratingVideo(false)}
    }

    /* Handlers: Batch & Reel */
    async function handleGenerateBatch(){
  if (appState.isGeneratingBatch) return;
  // ‚úÖ pull the last story (state first, then localStorage)
  const story =
    appState.currentStory ||
    (document.getElementById('storyContent')?.textContent?.trim()) ||
    localStorage.getItem('last_story');

  if (!story) {
    notifications.warning('Please generate a story first, then try batch image generation.');
  }

  appState.setGeneratingBatch(true);

  const payload = {
    text: story,  // ‚úÖ SEND THE STORY
    count: parseInt(batchCount.value || 4, 10),
    steps: parseInt(batchSteps.value || 30, 10),
    guidance_scale: parseFloat(batchGuidance.value || 5.5),
    base_prompt_prefix: batchBasePrefix.value || null
  };

  try {
    const r = await apiClient.generateImages(payload);
    if (r.success) {
      appState.setLastBatchImages(r.images);
      notifications.success(`Generated ${r.count} scene images using your story.`);
      console.log('üìù Story used for batch images (first 120 chars):', (story || '').slice(0, 120));
    } else {
      throw new Error(r.error || 'Batch generation failed');
    }
  } catch (e) {
    notifications.error('Batch image generation failed');
    console.error(e);
  } finally {
    appState.setGeneratingBatch(false);
  }
}

    async function handleGenerateReel(){
      if(appState.isGeneratingReel)return;
      appState.setGeneratingReel(true);
      const payload={
        fps: parseInt(reelFps.value||24,10),
        seconds_per_clip: parseFloat(reelSecondsPerClip.value||1.5),
        motion_bucket_id: parseInt(reelMotionBucket.value||127,10),
        noise_aug_strength: parseFloat(reelNoiseAug.value||0.02),
        target: reelTarget.value||'1080x1920'
      };
      // Add music if uploaded
      if(reelMusic.files&&reelMusic.files[0]){
        try{
          const musicDataUrl=await fileToDataURL(reelMusic.files[0]);
          payload.music=musicDataUrl;
        }catch(e){console.warn('Failed to read music file:',e)}
      }
      try{
        const r=await apiClient.generateReel(payload);
        if(r.success){
          appState.setLastReel(r.reel_url);
          notifications.success(`Reel created! Duration: ${r.duration.toFixed(1)}s, Resolution: ${r.resolution}`);
        }else{throw new Error(r.error||'Reel generation failed')}
      }catch(e){notifications.error('Reel generation failed');console.error(e)}
      finally{appState.setGeneratingReel(false)}
    }

    /* Health */
    async function checkSystemHealth(){
      const h=await apiClient.checkHealth();
      if(h){
        appState.updateSystemStatus({
          gemini: h.gemini_available,
          scraper: true,
          translator: h.translator_available,
          t2i: h.t2i_available,
          i2v: h.i2v_available
        });
      }
    }

    /* Events */
    scrapeBtn.addEventListener('click',handleScrapeTrends);
    generateBtn.addEventListener('click',handleGenerateStory);
    translateBtn.addEventListener('click',handleTranslateStory);
    englishTab.addEventListener('click',()=>appState.setView('english'));
    urduTab.addEventListener('click',()=>appState.setView('urdu'));

    // T2I
    generateImageBtn.addEventListener('click',handleGenerateImage);
    useImageForVideoBtn.addEventListener('click',useImageForVideo);

    // I2V
    //generateVideoBtn.addEventListener('click',handleGenerateVideo);
    //useLastImageBtn.addEventListener('click',useImageForVideo);

    // Batch & Reel
    generateBatchBtn.addEventListener('click',handleGenerateBatch);
    useBatchForReelBtn.addEventListener('click',()=>{
      if(appState.lastBatchImages.length===0){notifications.warning('No batch images available. Generate some first.');return}
      notifications.info('Using batch images for reel generation');
    });
    //generateReelBtn.addEventListener('click',handleGenerateReel);

    /*imageUpload.addEventListener('change',async (e)=>{
      const f=e.target.files&&e.target.files[0];
      if(!f)return;
      try{
        const dataUrl=await fileToDataURL(f);
        imageSrc.value=dataUrl;
        notifications.info('Loaded custom image (base64) for video');
      }catch(err){console.error(err);notifications.error('Failed to read image file')}
    });*/

    locationSelect.addEventListener('change',()=>{
      appState.currentLocation=locationSelect.value;appState.setTrends([]);
      storyContent.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="fas fa-globe"></i></div><div class="empty-title">Location Changed</div><div class="empty-description"></div></div>`;
      translationContent.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="fas fa-language"></i></div><div class="empty-title">Translation Ready</div><div class="empty-description">Generate a story first, then translate it to Urdu</div></div>`;
      storyStatus.textContent='Ready to generate';
    });

    // Shortcuts
    document.addEventListener('keydown',(e)=>{
      if(e.ctrlKey||e.metaKey){
        switch(e.key.toLowerCase()){
          case 's': e.preventDefault(); handleScrapeTrends(); break;
          case 'g': e.preventDefault(); if(appState.selectedTrend&&!appState.isGenerating){handleGenerateStory()} break;
          case 'u': e.preventDefault(); if(appState.currentStory&&!appState.isTranslating){handleTranslateStory()} break;
          case 'i': e.preventDefault(); if(!appState.isGeneratingImage){handleGenerateImage()} break;
        }
        if(e.shiftKey && e.key.toLowerCase()==='v'){e.preventDefault(); if(!appState.isGeneratingVideo){handleGenerateVideo()}}
        if(e.key.toLowerCase()==='t'){e.preventDefault(); themeManager.toggleTheme()}
        if(e.key==='1'){e.preventDefault(); if(appState.currentStory){appState.setView('english')}} 
        if(e.key==='2'){e.preventDefault(); if(appState.currentTranslation){appState.setView('urdu')}}
      }
    });

    // Init
    async function initializeApp(){
      notifications.info('Reelify is ready! Scrape trends, generate a story, then create images & videos.',5000);
      await checkSystemHealth();
      setInterval(checkSystemHealth,30000);
    }
    initializeApp();
  </script>
</body>
</html>
